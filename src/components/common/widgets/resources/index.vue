<template>
    <div class="flex flex-col w-full h-full overflow-auto gap-y-5">
        <div
            v-if="links(selectedAsset)?.length > 0"
            class="flex items-center justify-between px-5 bg-gray-50 py-2 border-b border-gray-200"
        >
            <span class="font-semibold text-gray-500">Resources</span>

            <AddResources
                :asset="selectedAsset"
                :edit-permission="linkEditPermission"
            >
                <template #trigger>
                    <div
                        class="text-gray-500 cursor-pointer flex items-center text-primary"
                    >
                        <AtlanIcon icon="Add" class="mr-1" /> Add
                    </div>
                </template>
            </AddResources>
        </div>
        <div class="px-5 pt-0">
            <div
                v-if="links(selectedAsset)?.length > 0"
                class="flex flex-col gap-y-4"
            >
                <div
                    v-for="(item, index) in links(selectedAsset)?.sort((a, b) =>
                        a.attributes.__timestamp < b.attributes.__timestamp
                            ? -1
                            : 1
                    )"
                    :key="index"
                >
                    <component
                        :is="getPreviewComponent(item?.attributes?.link)"
                        :edit-permission="linkEditPermission"
                        :item="item"
                        :selected-asset="selectedAsset"
                        class=""
                    />
                </div>
                <SlackUserLoginTrigger
                    v-if="
                        hasAtleastOneSlackLink &&
                        !userSlackStatus.configured &&
                        tenantSlackStatus.configured
                    "
                    class="mt-6"
                />
            </div>
            <div
                v-else
                class="flex flex-col items-center justify-center h-full mt-4 text-center text-gray-700"
            >
                <p class="mb-2 text-xl font-bold">Resources</p>
                <p class="text-sm">
                    Resources is the place to document all <br />knowledge
                    around the asset
                </p>
                <AtlanIcon
                    icon="EmptyResource2"
                    alt="EmptyResource"
                    class="w-auto my-10 h-44"
                />
                <div
                    class="flex flex-col mb-5 text-xs font-bold tracking-wide text-gray-500 gap-y-4"
                >
                    <span>Paul's Slack discussion around data type</span>
                    <span>The confluence doc that John wrote</span>
                    <span>The pdf that Ringo created</span>
                    <span>The Github issue that George started</span>
                </div>
                <AddResources
                    :asset="selectedAsset"
                    :edit-permission="linkEditPermission"
                >
                    <template #trigger>
                        <AtlanButton
                            size="lg"
                            color="primary"
                            padding="compact"
                        >
                            <AtlanIcon icon="Add" class="inline mb-0.5 mr-1" />
                            Add Resource
                        </AtlanButton>
                    </template>
                </AddResources>
            </div>
        </div>
    </div>
</template>

<script lang="ts">
    // Vue
    import dayjs from 'dayjs'
    import relativeTime from 'dayjs/plugin/relativeTime'

    import {
        defineComponent,
        PropType,
        computed,
        toRefs,
        defineAsyncComponent,
        ref,
    } from 'vue'
    import SlackUserLoginTrigger from '@common/integrations/slack/slackUserLoginTriggerCard.vue'
    import { assetInterface } from '~/types/assets/asset.interface'
    import AddResources from './addResource.vue'
    import useAssetInfo from '~/composables/discovery/useAssetInfo'
    import AtlanButton from '~/components/UI/button.vue'
    import integrationStore from '~/store/integrations/index'
    import AtlanIcon from '../../icon/atlanIcon.vue'
    import {
        isSlackLink,
        getChannelAndMessageIdFromSlackLink,
    } from '~/composables/integrations/useSlack'
    // import slackLinkPreview from './previews/slackLinkPreviewCard.vue'

    dayjs.extend(relativeTime)

    export default defineComponent({
        name: 'ResourceWidget',
        components: {
            SlackUserLoginTrigger,
            AddResources,
            AtlanButton,
            AtlanIcon,
            slackLinkPreview: defineAsyncComponent(
                () => import('./previews/slackLinkPreviewCard.vue')
            ),

            linkPreview: defineAsyncComponent(
                () => import('./previews/linkPreviewCard.vue')
            ),
        },
        props: {
            selectedAsset: {
                type: Object as PropType<assetInterface>,
                required: true,
            },
            isDrawer: {
                type: Boolean,
                required: false,
                default: false,
            },
        },
        setup(props) {
            const timeAgo = (time: string) => dayjs().from(time, true)
            const { links, selectedAssetUpdatePermission, assetPermission } =
                useAssetInfo()

            const store = integrationStore()
            const { tenantSlackStatus, userSlackStatus } = toRefs(store)

            function getPreviewComponent(url) {
                if (
                    isSlackLink(url) &&
                    tenantSlackStatus.value.configured &&
                    userSlackStatus.value.configured
                ) {
                    return 'slackLinkPreview'
                }
                return 'linkPreview'
            }

            const { selectedAsset, isDrawer } = toRefs(props)

            const hasAtleastOneSlackLink = computed(() => {
                const linkArr = links(selectedAsset.value)
                const slackLink = linkArr.some((link) =>
                    isSlackLink(link?.attributes?.link)
                )
                return slackLink
            })

            const linkEditPermission = computed(
                () =>
                    selectedAssetUpdatePermission(
                        selectedAsset.value,
                        isDrawer.value,
                        'RELATIONSHIP_ADD',
                        'Link'
                    ) && assetPermission('CREATE_LINK')
            )

            return {
                tenantSlackStatus,
                userSlackStatus,
                links,
                linkEditPermission,
                hasAtleastOneSlackLink,
                isSlackLink,
                timeAgo,
                getPreviewComponent,
            }
        },
    })
</script>
<style lang="less" scoped>
    .slack-icon-avatar-overlay {
        height: 1rem;
        bottom: -3px;
        right: -6px;
        border-radius: 100px;
        /* box-shadow: -1px 1px 4px white; */
        background: white;
        padding: 0.9px;
    }
    .min-w-link-left-col {
        min-width: 2rem;
    }
</style>
