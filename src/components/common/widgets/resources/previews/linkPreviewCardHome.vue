<template>
    <div class="flex flex-col px-3 py-2 cursor-pointer hover:bg-gray-100">
        <div class="flex justify-between">
            <div class="flex items-center flex-1" @click="openLink(link(item))">
                <div class="mr-1 min-w-link-left-col">
                    <AtlanIcon
                        v-if="defaultIcon || link(item) === ''"
                        icon="Link"
                        class="w-auto h-7"
                    />
                    <img
                        v-else
                        :src="
                            getDomain(link(item)) !== 'atlan.com'
                                ? `https://www.google.com/s2/favicons?domain=${getDomain(
                                      link(item)
                                  )}&sz=64`
                                : '/ico.ico'
                        "
                        alt=""
                        :onerror="imageLoadOnError"
                        class="h-7"
                    />
                </div>
                <div class="flex flex-col">
                    <a
                        :href="`${link(item)}`"
                        target="_blank"
                        rel="noreferrer"
                        class="text-primary"
                        ><Tooltip
                            :tooltip-text="title(item) || link(item)"
                            classes="hover:text-primary font-gray-700 cursor-pointer hover:underline font-semibold text-xs "
                        />
                    </a>
                    <div
                        v-if="createdBy(item) === modifiedBy(item)"
                        class="text-xs text-gray-500"
                    >
                        added by {{ createdBy(item) }} {{ createdAt(item) }}
                    </div>
                    <div v-else class="text-xs text-gray-500">
                        edited by {{ modifiedBy(item) }} {{ modifiedAt(item) }}
                    </div>
                </div>
            </div>
            <div>
                <a-dropdown
                    trigger="click"
                    placement="bottomRight"
                    v-if="editPermission"
                >
                    <div>
                        <AtlanIcon
                            icon="KebabMenu"
                            class="h-4 m-0 cursor-pointer hover:text-primary"
                        />
                    </div>

                    <template #overlay>
                        <a-menu mode="vertical">
                            <EditResource
                                :asset="selectedAsset"
                                :edit-permission="editPermission"
                                :item="item"
                                :updating="true"
                                ><template #trigger>
                                    <a-menu-item key="edit">
                                        <div class="flex items-center">
                                            <AtlanIcon
                                                icon="Edit"
                                                class="h-4 mb-0.5 mr-1"
                                            />
                                            Edit
                                        </div>
                                    </a-menu-item></template
                                ></EditResource
                            >
                            <DeleteResource
                                :asset="selectedAsset"
                                :item="item"
                                :edit-permission="editPermission"
                                ><template #trigger>
                                    <a-menu-item key="delete">
                                        <div
                                            class="flex items-center text-red-500"
                                        >
                                            <AtlanIcon
                                                icon="Delete"
                                                class="h-4 mb-0.5 mr-1"
                                            />
                                            Delete
                                        </div>
                                    </a-menu-item></template
                                ></DeleteResource
                            >
                        </a-menu>
                    </template>
                </a-dropdown>
            </div>
        </div>
        <AssetTitleCtx
            v-if="showAssetName"
            :item="item.attributes.asset"
            class="mt-2"
        ></AssetTitleCtx>
    </div>
</template>

<script lang="ts">
    // Vue
    import { defineComponent, PropType, ref, toRefs } from 'vue'
    import { getDomain } from '~/utils/url'
    import useAssetInfo from '~/composables/discovery/useAssetInfo'
    import { assetInterface } from '~/types/assets/asset.interface'
    import DeleteResource from '../deleteResource.vue'
    import EditResource from '../addResource.vue'
    import Tooltip from '@/common/ellipsis/index.vue'

    import AssetTitleCtx from './assetTitleContext.vue'

    export default defineComponent({
        components: {
            DeleteResource,
            EditResource,
            Tooltip,

            AssetTitleCtx,
        },
        props: {
            item: {
                type: Object as PropType<assetInterface>,
                required: true,
            },
            selectedAsset: {
                type: Object as PropType<assetInterface>,
                required: false,
                default: () => {},
            },
            editPermission: {
                type: Boolean,
                required: false,
                default: false,
            },
            showAssetName: {
                type: Boolean,
                required: false,
                default: false,
            },
        },
        setup(props) {
            const { showAssetName } = toRefs(props)
            const defaultIcon = ref(false)

            function openLink(url) {
                if (!url) {
                    return
                }
                window.open(url)
            }
            const {
                createdBy,
                modifiedBy,
                createdAt,
                modifiedAt,
                title,
                link,
            } = useAssetInfo()

            const imageLoadOnError = (e) => {
                console.log('replace image')
                defaultIcon.value = true
            }

            return {
                getDomain,
                createdBy,
                modifiedBy,
                createdAt,
                modifiedAt,
                title,
                link,
                openLink,
                imageLoadOnError,
                defaultIcon,
                showAssetName,
            }
        },
    })
</script>
<style lang="less" scoped>
    .min-w-link-left-col {
        min-width: 2rem;
    }
</style>
