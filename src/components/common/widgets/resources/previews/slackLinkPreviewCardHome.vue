<template>
    <template v-if="isLoading">
        <div class="p-2">
            <a-skeleton
                :loading="true"
                avatar
                active
                :title="false"
                :paragraph="{ rows: 2 }"
            />
        </div>
    </template>
    <LinkPreview v-else-if="error" v-bind="$props" />
    <template v-else>
        <div class="flex flex-col px-3 py-2 cursor-pointer hover:bg-gray-100">
            <div class="flex" @click="openLink(item?.attributes?.link)">
                <template v-if="data">
                    <div class="relative h-8 mr-3 min-w-link-left-col">
                        <!-- avatar -->
                        <img
                            class="rounded-full"
                            :src="data.user.image_32"
                            alt=""
                        />
                        <AtlanIcon
                            :icon="'Slack'"
                            class="absolute slack-icon-avatar-overlay"
                        ></AtlanIcon>
                    </div>

                    <div class="flex flex-col">
                        <div class="flex items-center">
                            <!-- sender -->
                            <span class="mr-2 font-semibold text-xs">{{
                                data.user.real_name
                            }}</span>
                            <span class="text-xs text-gray-500">
                                {{
                                    timeAgo(
                                        new Date(
                                            data.message.ts * 1000
                                        ).toISOString()
                                    )
                                }}
                                ago</span
                            >
                        </div>
                        <ShowLess
                            :text="stripSlackText(data.message.text ?? '')"
                            class="text-xs mt-0.5"
                        />

                        <div class="flex text-xs text-gray-500 mt-1">
                            <span v-if="data.message.reply_count" class="">
                                {{ data.message.reply_count }}
                                replies
                                <span class="ml-1 mr-1 text-gray-300">â€¢</span>
                            </span>
                            <span v-if="data?.channel?.name">
                                #{{ data?.channel?.name }}
                            </span>
                            <span v-else> Private dm</span>
                        </div>
                    </div>
                    <div class="flex-grow"></div>
                    <!-- extract this into component -->
                </template>
            </div>
            <AssetTitleCtx
                :item="item.attributes.asset"
                class="mt-2"
            ></AssetTitleCtx>
        </div>
    </template>
</template>

<script lang="ts">
    // Vue
    import dayjs from 'dayjs'
    import relativeTime from 'dayjs/plugin/relativeTime'

    import { defineComponent, computed, toRefs, watch } from 'vue'

    import {
        getChannelAndMessageIdFromSlackLink,
        UnfurlSlackMessage,
        stripSlackText,
    } from '~/composables/integrations/useSlack'
    import LinkPreview from '@/common/widgets/resources/previews/linkPreviewCardHome.vue'
    import DeleteResource from '../deleteResource.vue'
    import EditResource from '../addResource.vue'
    import ShowLess from '@/UI/showLess.vue'
    import integrationStore from '~/store/integrations/index'
    import AssetTitleCtx from './assetTitleContext.vue'

    dayjs.extend(relativeTime)

    export default defineComponent({
        components: {
            LinkPreview,
            DeleteResource,
            EditResource,
            ShowLess,
            AssetTitleCtx,
        },
        props: {
            item: {
                type: Object,
                required: true,
            },
            selectedAsset: {
                type: Object,
                required: false,
                default: () => {},
            },
            editPermission: {
                type: Boolean,
                required: false,
                default: false,
            },
        },
        setup(props) {
            const timeAgo = (time: string) => dayjs().from(time, true)

            const { item } = toRefs(props)
            const body = computed(() => {
                const { channelId, messageId } =
                    getChannelAndMessageIdFromSlackLink(
                        item.value.attributes.link
                    )
                return {
                    conversationId: channelId,
                    messageId,
                }
            })
            const { data, isLoading, error, mutate } = UnfurlSlackMessage(
                body,
                {
                    immediate: true,
                }
            )
            watch(
                () => item.value.attributes.link,
                () => {
                    mutate()
                }
            )

            const store = integrationStore()

            const { userSlackStatus } = toRefs(store)

            // ? watch for user level slack integration configuration status and try refresh
            watch(
                () => userSlackStatus.value.configured,
                (v) => {
                    if (v) mutate()
                }
            )

            function openLink(url) {
                if (!url) {
                    return
                }
                window.open(url)
            }

            return {
                stripSlackText,
                data,
                isLoading,
                error,
                timeAgo,
                openLink,
            }
        },
    })
</script>
<style lang="less" scoped>
    .slack-icon-avatar-overlay {
        height: 1rem;
        bottom: -3px;
        right: -6px;
        border-radius: 100px;
        /* box-shadow: -1px 1px 4px white; */
        background: white;
        padding: 0.9px;
    }
    .min-w-link-left-col {
        min-width: 2rem;
    }
</style>
