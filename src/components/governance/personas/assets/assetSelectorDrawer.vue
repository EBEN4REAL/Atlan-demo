<template>
    <a-drawer
        placement="right"
        :destroy-on-close="true"
        :visible="isVisible"
        :get-container="false"
        :closable="false"
        :mask="false"
        :class="$style.drawerStyle"
        :width="460"
    >
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between">
                <span class="px-4 pt-4 text-lg font-bold text-gray-700"
                    >Select Assets</span
                >
                <AtlanBtn
                    class="ml-auto mr-2 border-none"
                    size="sm"
                    padding="compact"
                    color="secondary"
                    @click="() => (isVisible = false)"
                >
                    <AtlanIcon icon="Cross" class="-mx-1" />
                </AtlanBtn>
            </div>

            <RaisedTab
                v-model:active="activeTab"
                class="mt-3 ml-4 mr-auto"
                :data="tabConfig"
            />
            <a-divider class="my-4" />

            <div
                class="relative overflow-x-hidden overflow-y-hidden  drawer_height"
            >
                <div
                    class="absolute w-full h-full bg-white"
                    :class="
                        activeTab === 'tree' ? 'front-z-index' : 'rear-z-index'
                    "
                >
                    <span class="mx-4 mt-2 text-base font-bold text-gray-500"
                        >Browse from your assets</span
                    >
                    <div class="h-full p-4 overflow-y-auto">
                        <AssetBrowserTree
                            v-model:assets="checkedKeys"
                            :connection-qf-name="connectionQfName"
                        />
                    </div>
                </div>

                <div
                    class="absolute w-full h-full bg-white"
                    :class="
                        activeTab === 'list' ? 'front-z-index' : 'rear-z-index'
                    "
                >
                    <span class="mx-4 mt-2 text-base font-bold text-gray-500"
                        >Search from your assets</span
                    >
                    <!-- <AssetsWrapper class="h-full" :data-map="filterConfig" /> -->
                    <AssetsWrapper
                        :show-filters="false"
                        :static-use="true"
                        :show-aggrs="false"
                        :initial-filters="filterConfig"
                        class="asset-list-height"
                        page="personas"
                    />
                </div>

                <div
                    class="absolute w-full h-full bg-white"
                    :class="
                        activeTab === 'custom'
                            ? 'front-z-index'
                            : 'rear-z-index'
                    "
                >
                    <span class="mx-4 mt-2 text-base font-bold text-gray-500"
                        >Select assets matching
                    </span>
                    <CustomAssetSelector
                        v-model:assets="regexKeys"
                        class="h-full py-4"
                        :connection-qf-name="connectionQfName"
                    />
                </div>
            </div>

            <a-divider />
            <div class="flex items-center justify-end m-2 gap-x-2">
                <span class="text-base font-bold text-gray-500"
                    >{{ selectedAssetCount || 'No' }} items selected</span
                >
                <AtlanBtn
                    size="sm"
                    padding="compact"
                    color="secondary"
                    @click="closeDrawer"
                    >Cancel</AtlanBtn
                >
                <AtlanBtn size="sm" padding="compact" @click="saveAssets"
                    >Save</AtlanBtn
                >
            </div>
        </div>
    </a-drawer>
</template>

<script lang="ts">
    import {
        computed,
        defineComponent,
        PropType,
        ref,
        toRefs,
        watch,
    } from 'vue'
    import AtlanBtn from '@/UI/button.vue'
    import RaisedTab from '@/UI/raisedTab.vue'
    import AssetBrowserTree from './assetBrowserTree.vue'
    import CustomAssetSelector from './customAssetSelector.vue'
    import useBulkUpdateStore from '~/store/bulkUpdate'
    import AssetsWrapper from '@/assets/index.vue'

    export default defineComponent({
        name: 'AssetSelector',
        components: {
            AtlanBtn,
            AssetBrowserTree,
            RaisedTab,
            AssetsWrapper,
            CustomAssetSelector,
        },
        props: {
            connectionQfName: {
                type: String,
                required: true,
            },
            assets: {
                type: Array as PropType<string[]>,
                required: true,
            },
            visible: {
                type: Boolean,
                default: () => false,
            },
        },
        emits: ['update:visible', 'update:assets'],
        setup(props, { emit }) {
            const { visible, assets, connectionQfName } = toRefs(props)

            const bulkStore = useBulkUpdateStore()

            // Drawer Visibility
            const isVisible = computed({
                get: () => visible.value,
                set: (val) => {
                    emit('update:visible', val)
                },
            })

            // Asset related stuff
            const checkedKeys = ref([...assets.value] as string[])
            const regexKeys = ref([] as string[])
            const BIAssets = ['powerbi', 'tableau']

            const getConnectorName = (qualifiedName: string) => {
                let attributeValues: string[]
                let connectorName: string = ''
                if (qualifiedName) {
                    attributeValues = qualifiedName?.split('/')
                    if (attributeValues.length > 0) {
                        connectorName = attributeValues[1]
                    }
                }

                return connectorName
            }

            function resetAssetState() {
                isVisible.value = false
            }

            function closeDrawer() {
                isVisible.value = false
            }

            const getQualifiedNamesFromAssets = (assets: any[]) => {
                return assets.map((asset) => asset?.attributes.qualifiedName)
            }
            /* Adds /* to pathname */
            const addSufffix = (qualifiedNames: string[]) => {
                return (
                    qualifiedNames?.map(
                        (qualifiedName) => `${qualifiedName}/*`
                    ) ?? []
                )
            }

            function saveAssets() {
                // TODO: Optional* Change this implementation
                // Use a WritableComputedRef and the @check event
                // to see which node got selected or unselected and
                // use a set to maintain the state
                const assetSet = new Set([
                    ...checkedKeys.value,
                    ...assets.value,
                    ...regexKeys.value,
                    ...getQualifiedNamesFromAssets(
                        bulkStore.bulkSelectedAssets
                    ),
                ])
                emit('update:assets', [...assetSet])
                resetAssetState()
            }

            const selectedAssetCount = computed(() => {
                const s = new Set([
                    ...checkedKeys?.value,
                    ...assets.value,
                    ...bulkStore.bulkSelectedAssets,
                ])
                return s.size
            })

            const filterConfig = computed(() => ({
                connectorName: getConnectorName(connectionQfName.value),
                connectionQualifiedName: connectionQfName.value,
            }))

            // Tab related data
            const activeTab = ref('custom')
            const tabConfig = ref([{ key: 'custom', label: 'Custom' }])

            watch(
                connectionQfName,
                () => {
                    if (
                        BIAssets.includes(
                            getConnectorName(connectionQfName.value)
                        )
                    ) {
                        tabConfig.value = [{ key: 'custom', label: 'Custom' }]
                        tabConfig.value.unshift({
                            key: 'list',
                            label: 'Search',
                        })
                        activeTab.value = 'list'
                    } else {
                        tabConfig.value = [{ key: 'custom', label: 'Custom' }]
                        tabConfig.value.unshift({
                            key: 'list',
                            label: 'Search',
                        })
                        tabConfig.value.unshift({
                            key: 'tree',
                            label: 'Browse',
                        })
                        activeTab.value = 'tree'
                    }
                },
                { immediate: true }
            )

            return {
                closeDrawer,
                filterConfig,
                activeTab,
                tabConfig,
                isVisible,
                checkedKeys,
                regexKeys,
                saveAssets,
                resetAssetState,
                selectedAssetCount,
            }
        },
    })
</script>

<style lang="less" module>
    .drawerStyle {
        :global(.ant-drawer-body) {
            overflow-y: hidden;
            height: 100%;
        }
    }
</style>
<style lang="less" scoped>
    .rear-z-index {
        z-index: 1001;
    }
    .front-z-index {
        z-index: 1002;
    }
    .drawer_height {
        height: calc(100vh - 14rem);
    }
</style>
