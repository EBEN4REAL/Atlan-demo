<template>
    <div class="h-full">
        <DefaultLayout title="Query Logs">
            <template #header>
                <div class="flex items-center justify-between pb-3">
                    <div class="flex items-stretch w-full">
                        <div class="flex items-center">
                            <a-button
                                type="default"
                                class="px-2 rounded-tr-none rounded-br-none"
                                :class="
                                    queryLogsFilterDrawerVisible
                                        ? 'text-primary border-primary'
                                        : 'border-gray-300  border rounded-tl rounded-bl text-gray '
                                "
                            >
                                <AtlanIcon
                                    :icon="'FilterFunnel'"
                                    class="w-4 h-4"
                                    @click="
                                        queryLogsFilterDrawerVisible =
                                            !queryLogsFilterDrawerVisible
                                    "
                                />
                            </a-button>
                        </div>
                        <a-input-search
                            v-model:value="searchText"
                            :placeholder="
                                filteredLogsCount
                                    ? `Search through ${filteredLogsCount} logs`
                                    : `Search logs`
                            "
                            class="w-1/3 mr-1 border border-l-0 border-gray-300 rounded-none rounded-tr rounded-br shadow-sm "
                            size="default"
                            :allow-clear="true"
                            @change="handleSearch"
                        ></a-input-search>
                    </div>
                    <div class="flex-grow w-0"></div>

                    <TimeFrameSelector
                        v-model:modelValue="timeFrame"
                        :time-frame="timeFrame"
                        @change="handleRangePickerChange"
                    />
                </div>
            </template>

            <QueryLogTable
                :api-keys-list="queryList"
                :is-loading="isLoading"
                :selected-query="selectedQuery"
                :selected-row-keys="selectedRowKeys"
                @selectQuery="handleSelectQuery"
            />
            <!-- <div class="flex justify-end max-w-full "> -->
            <div
                v-if="(queryList && queryList.length) || isLoading"
                class="flex flex-row items-center justify-end w-full mt-4"
            >
                <AtlanBtn
                    class="bg-transparent rounded-r-none"
                    size="sm"
                    color="secondary"
                    padding="compact"
                    :disabled="pagination.current === 1"
                    @click="handlePagination(pagination.current - 1)"
                >
                    <AtlanIcon icon="CaretLeft" />
                </AtlanBtn>
                <AtlanBtn
                    class="bg-transparent border-l-0 border-r-0 rounded-none cursor-default "
                    size="sm"
                    color="secondary"
                    padding="compact"
                >
                    {{ pagination.current }} of
                    <span v-if="Math.ceil(pagination.total)">{{
                        Math.ceil(pagination.total)
                    }}</span>

                    <div
                        v-else-if="isLoading"
                        class="flex items-center justify-center"
                    >
                        <AtlanIcon icon="CircleLoader" class="animate-spin" />
                    </div>
                </AtlanBtn>

                <AtlanBtn
                    class="bg-transparent rounded-l-none"
                    size="sm"
                    color="secondary"
                    padding="compact"
                    :disabled="
                        pagination.current === Math.ceil(pagination.total)
                    "
                    @click="handlePagination(pagination.current + 1)"
                >
                    <AtlanIcon icon="CaretRight" />
                </AtlanBtn>
            </div>
            <!-- </div> -->
        </DefaultLayout>
        <a-drawer
            :visible="isQueryPreviewDrawerVisible"
            :mask="false"
            :width="420"
            class="api-key"
            :closable="false"
        >
            <QueryPreviewDrawer
                :query="selectedQuery"
                @closeDrawer="toggleQueryPreviewDrawer"
                @selectQuery="handleSelectQuery"
            />
        </a-drawer>
        <a-drawer
            :visible="queryLogsFilterDrawerVisible"
            :mask="false"
            :placement="'left'"
            :width="270"
            :closable="false"
        >
            <AssetFilters
                v-model="facets"
                :filter-list="queryLogsFilter"
                :allow-custom-filters="false"
                class="bg-gray-100"
                @change="handleFilterChange"
                @reset="handleResetEvent"
            >
                <Connector
                    v-model:data="facets.connector"
                    :bg-gray-for-selector="false"
                    :filter-source-ids="['powerbi', 'tableau']"
                    class="px-2 py-3"
                    @change="handleFilterChange"
            /></AssetFilters>
        </a-drawer>
    </div>
</template>

<script lang="ts">
import { defineComponent, ref, Ref, watch, computed } from 'vue'
import dayjs from 'dayjs'
import { useDebounceFn } from '@vueuse/core'
import map from '~/constant/accessControl/map'
import DefaultLayout from '~/components/admin/layout.vue'
import AtlanBtn from '@/UI/button.vue'
import QueryLogTable from '@/governance/queryLogs/queryTable.vue'
import QueryPreviewDrawer from '~/components/governance/queryLogs/queryDrawer.vue'
import NewAPIKeyIllustration from '~/assets/images/illustrations/new_apikey.svg'
import TimeFrameSelector from '~/components/admin/common/timeFrameSelector.vue'
import { useQueryLogs } from './composables/useQueryLogs'
import AssetFilters from '@/common/assets/filters/index.vue'
import { queryLogsFilter } from '~/constant/filters/logsFilter'
import Connector from '~/components/insights/common/connector/connector.vue'
import { useConnector } from '~/components/insights/common/composables/useConnector'

export default defineComponent({
    name: 'QueryLogsView',
    components: {
        DefaultLayout,
        AtlanBtn,
        QueryLogTable,
        TimeFrameSelector,
        QueryPreviewDrawer,
        AssetFilters,
        Connector,
    },
    setup() {
        /** LOCAL STATE */
        const facets = ref({})
        const searchText: Ref<string> = ref('')
        const queryLogsFilterDrawerVisible: Ref<boolean> = ref(false)
        const timeFrame = ref('30 days')
        const selectedQuery = ref({})
        const isQueryPreviewDrawerVisible = ref(false)
        const gte = ref(
            dayjs(new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)).format()
        )
        const lt = ref(dayjs().format())
        const from = ref(0)
        const size = ref(6)
        const { getDatabaseName, getSchemaName, getConnectionQualifiedName } =
            useConnector()
        const {
            list: queryList,
            mutateBody,
            refetchList,
            isLoading,
            filteredLogsCount,
        } = useQueryLogs(gte, lt, from, size)

        const toggleQueryPreviewDrawer = (
            val: boolean | undefined = undefined
        ) => {
            if (val === undefined)
                isQueryPreviewDrawerVisible.value =
                    !isQueryPreviewDrawerVisible.value
            else isQueryPreviewDrawerVisible.value = val
        }

        const setSelectedQuery = (query: Object) => {
            selectedQuery.value = query
        }
        const handleSelectQuery = (query: Object) => {
            if (
                isQueryPreviewDrawerVisible.value &&
                query._id === selectedQuery.value._id
            ) {
                isQueryPreviewDrawerVisible.value = false
            } else if (!isQueryPreviewDrawerVisible.value) {
                isQueryPreviewDrawerVisible.value = true
            }
            setSelectedQuery(query)
        }
        const selectedRowKeys = computed(() =>
            selectedQuery.value?._id !== undefined
                ? [selectedQuery.value?._id]
                : []
        )
        const pagination = computed(() => ({
            total: filteredLogsCount.value / size.value,
            pageSize: size.value,
            current: from.value / size.value + 1,
        }))
        const refreshList = () => {
            const usernames = facets.value?.users?.ownerUsers
            const queryStatusValues = facets.value?.queryStatus?.status
            const connectorFacet = facets.value?.connector?.attributeName
            const facetValue = facets.value?.connector?.attributeValue
            let schemaName = ''
            let dbName = ''
            let connectionQF = ''
            let connectorName = ''
            if (connectorFacet) {
                if (connectorFacet === 'schemaQualifiedName') {
                    dbName = getDatabaseName(facetValue) || ''
                    schemaName = getSchemaName(facetValue) || ''
                    connectionQF = getConnectionQualifiedName(facetValue) || ''
                } else if (connectorFacet === 'databaseQualifiedName') {
                    dbName = getDatabaseName(facetValue) || ''
                    connectionQF = getConnectionQualifiedName(facetValue) || ''
                } else if (connectorFacet === 'connectionQualifiedName') {
                    connectionQF = facetValue || ''
                } else if (connectorFacet === 'connectorName') {
                    connectorName = facetValue || ''
                }
            }
            mutateBody({
                from,
                size,
                gte,
                lt,
                usernames,
                queryStatusValues,
                dbName,
                schemaName,
                connectionQF,
                connectorName,
                searchText: searchText.value,
            })
            refetchList()
        }
        const handleFilterChange = () => {
            from.value = 0
            refreshList()
        }
        const handlePagination = (page) => {
            const offset = (page - 1) * size.value
            from.value = offset
            refreshList()
        }

        const handleRangePickerChange = (e) => {
            gte.value = e[0]
            lt.value = e[1]
            refreshList()
        }
        const handleSearch = useDebounceFn(() => {
            from.value = 0
            refreshList()
        }, 200)
        const handleResetEvent = () => {
            facets.value = {}
            handleFilterChange()
        }
        return {
            selectedRowKeys,
            isQueryPreviewDrawerVisible,
            selectedQuery,
            queryList,
            isLoading,
            handleSearch,
            handleSelectQuery,
            toggleQueryPreviewDrawer,
            handleRangePickerChange,
            timeFrame,
            searchText,
            queryLogsFilterDrawerVisible,
            NewAPIKeyIllustration,
            map,
            queryLogsFilter,
            handleFilterChange,
            handleResetEvent,
            facets,
            pagination,
            filteredLogsCount,
            handlePagination,
        }
    },
})
</script>
