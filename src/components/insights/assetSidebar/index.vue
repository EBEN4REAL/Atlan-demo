<template>
    <div
        v-if="selectedAsset?.guid"
        class="relative z-20 flex flex-col h-full bg-white asset-preview-container"
    >
        <div
            v-if="activeInlineTab?.assetSidebar?.isVisible"
            class="close-btn-add-policy"
            @click="handleClose"
        >
            <AtlanIcon icon="Add" class="text-white" />
        </div>

        <AssetPreview
            :selected-asset="
                Object.keys(assetInfo)?.length ? assetInfo : selectedAsset
            "
            page="insights"
        ></AssetPreview>
    </div>
    <div
        v-else
        class="relative flex flex-col items-center justify-center h-full -mt-12"
    >
        <div
            v-if="activeInlineTab?.assetSidebar?.isVisible"
            class="close-btn-add-policy"
            @click="handleClose"
        >
            <AtlanIcon icon="Add" class="text-white" />
        </div>
        <AtlanIcon icon="NoSelectedAsset" class="w-36 h-28" />
        <div class="px-8 mt-6 text-base text-center text-gray-700">
            This is where you will find information about your data assets
        </div>
    </div>
</template>

<script lang="ts">
    import {
        defineComponent,
        Ref,
        inject,
        ComputedRef,
        computed,
        ref,
        watch,
        provide,
        toRaw,
    } from 'vue'
    import { activeInlineTabInterface } from '~/types/insights/activeInlineTab.interface'
    import { useAssetSidebar } from '~/components/insights/assetSidebar/composables/useAssetSidebar'
    import AssetPreview from '~/components/common/assets/preview/index.vue'
    import useAssetStore from '~/store/asset'
    import AtlanIcon from '~/components/common/icon/atlanIcon.vue'
    import { useInlineTab } from '~/components/insights/common/composables/useInlineTab'
    import { SavedQueryInterface } from '~/types/insights/savedQuery.interface'
    import { QueryCollection } from '~/types/insights/savedQuery.interface'
    import { useSavedQuery } from '~/components/insights/explorers/composables/useSavedQuery'

    export default defineComponent({
        components: { AssetPreview, AtlanIcon },
        props: {},
        setup(props, { emit }) {
            // const storeDiscovery = useAssetStore()
            const activeInlineTab = inject(
                'activeInlineTab'
            ) as ComputedRef<activeInlineTabInterface>

            const { modifyActiveInlineTab } = useInlineTab()

            const tabs = inject('inlineTabs') as Ref<activeInlineTabInterface[]>

            const activeInlineTabKey = inject(
                'activeInlineTabKey'
            ) as Ref<string>

            const { checkQueryOpenedInTab, checkPreviewOpenedInCurrentTab } =
                useSavedQuery(tabs, activeInlineTab, activeInlineTabKey)

            const { closeAssetSidebar, fetchAssetData } = useAssetSidebar(
                tabs,
                activeInlineTab
            )

            const assetLoading = ref(false)
            const assetInfo = ref({})

            const selectedAsset: Ref<any> = computed(() => {
                return activeInlineTab.value?.assetSidebar?.assetInfo
            })

            const queryCollections = inject('queryCollections') as ComputedRef<
                QueryCollection[] | undefined
            >

            const updateAssetCheck = inject('updateAssetCheck') as Ref<Boolean>

            const collectionName = computed(() => {
                let col = queryCollections.value?.find(
                    (col) =>
                        col.attributes.qualifiedName ===
                        selectedAsset.value?.attributes?.collectionQualifiedName
                )
                if (col) {
                    return col?.displayText
                }
                return null
            })

            const fetchAsset = () => {
                const { data, isLoading, error } = fetchAssetData(
                    activeInlineTab.value?.assetSidebar?.assetInfo
                )
                assetLoading.value = true
                watch([data, error, isLoading], () => {
                    assetLoading.value = true
                    if (isLoading.value === false) {
                        assetLoading.value = false
                        if (error.value === undefined) {
                            if (
                                data.value?.entities &&
                                data.value?.entities?.length > 0
                            ) {
                                // console.log('updated asset data: ', data.value)
                                assetInfo.value = data.value.entities[0]
                            } else {
                                assetInfo.value = {}
                            }
                        } else {
                            assetLoading.value = false
                        }
                    }
                })
            }

            watch(selectedAsset, () => {
                assetInfo.value = {}
                // console.log('selected asset: ', selectedAsset.value)
                fetchAsset()
            })

            watch(
                updateAssetCheck,
                () => {
                    // console.log('asset update')
                    assetInfo.value = {}
                    if (updateAssetCheck.value) {
                        // console.log('asset update2')
                        fetchAsset()
                        updateAssetCheck.value = false
                    }
                },
                { immediate: true }
            )

            const assetSidebarUpdatedData = inject(
                'assetSidebarUpdatedData'
            ) as Ref<Object>

            const updateList = (asset) => {
                // let activeInlineTabCopy: activeInlineTabInterface = JSON.parse(
                //     JSON.stringify(toRaw(activeInlineTab.value))
                // )
                // console.log('updated asset: ', asset)

                let activeInlineTabCopy: activeInlineTabInterface = JSON.parse(
                    JSON.stringify(toRaw(activeInlineTab.value))
                )

                // console.log('updated asset: ', asset)
                assetSidebarUpdatedData.value = asset

                if (asset?.typeName === 'Query') {
                    if (activeInlineTabCopy.queryId === asset?.guid) {
                        activeInlineTabCopy = {
                            ...activeInlineTabCopy,
                            updateTime:
                                asset?.updateTime ??
                                asset?.attributes.__modificationTimestamp,
                            updatedBy:
                                asset?.updatedBy ??
                                asset?.attributes.__modifiedBy,
                            description: asset?.attributes.description,
                            status: asset?.attributes.certificateStatus,
                            attributes: { ...asset?.attributes },
                            label: asset?.attributes?.name,
                        }
                        activeInlineTabCopy.assetSidebar.assetInfo = asset
                    }
                    modifyActiveInlineTab(activeInlineTabCopy, tabs, true, true)
                } else {
                    activeInlineTabCopy.assetSidebar.assetInfo = asset
                    modifyActiveInlineTab(activeInlineTabCopy, tabs, true, true)
                }
                // console.log('old data update: ', asset)
            }

            provide('updateList', updateList)

            const handleClose = () => {
                activeInlineTab.value.assetSidebar.isVisible = false
            }

            return {
                handleClose,
                selectedAsset,
                tabs,
                activeInlineTab,
                closeAssetSidebar,
                assetInfo,
                collectionName,
            }
        },
    })
</script>
<style lang="less" scoped>
    .asset-preview-container {
        min-width: 420px !important;
        max-width: 420px !important;
    }
    .placeholder {
        background-color: #f4f4f4;
    }
    .show-sidebar {
        width: 420px;
        min-width: 420px;
    }
    .hide-sidebar {
        width: 0px;
        min-width: 0px;
    }
    .sidebar {
        // transition: all 0.22s;
    }
    .close-btn-add-policy {
        // padding: 10px;
        height: 32px;
        width: 32px;
        background: #3e4359cc;
        position: fixed;
        border-radius: 50%;
        display: grid;
        place-items: center;
        transform: rotate(45deg);
        right: 430px;
        top: 60px;
        z-index: 20;
        cursor: pointer;
    }
</style>

<route lang="yaml">
meta:
    layout: default
    requiresAuth: true
</route>
